<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wavefunction Calculator - Quantum Chemistry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .code-block { font-family: 'Courier New', monospace; }
        .log-output {
            background: #f8f9fa;
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.3;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 500px;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .log-debug { color: #6c757d; }
        .log-info { color: #0f5132; }
        .log-warn { color: #664d03; }
        .log-error { color: #842029; }
        .matrix-display {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0;
            overflow: auto;
            max-height: 500px;
        }
        .matrix-table {
            border-collapse: collapse;
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }
        .matrix-table td {
            padding: 2px 6px;
            text-align: right;
            border: 1px solid #e0e0e0;
            white-space: nowrap;
            min-width: 80px;
        }
        .matrix-table th {
            padding: 2px 6px;
            text-align: center;
            border: 1px solid #ccc;
            background: #f0f0f0;
            font-weight: bold;
            font-size: 9px;
        }
        .matrix-table .row-header {
            background: #f8f8f8;
            font-weight: bold;
            text-align: center;
            min-width: 40px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Wavefunction Calculator</h1>
                    <p class="text-sm text-gray-600">Quantum Chemistry Calculations from XYZ Files</p>
                </div>
                <div id="moleculeHeaderInfo" class="text-right text-sm text-gray-600 hidden">
                    <div id="moleculeName" class="font-medium text-gray-900"></div>
                    <div id="moleculeFormula" class="text-gray-600"></div>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="flex h-screen">
            <!-- Left Sidebar -->
            <div class="w-80 bg-white border-r border-gray-200 p-6 space-y-6 overflow-y-auto">
                <!-- File Upload Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Upload Molecule</h3>
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-gray-400 transition-colors">
                        <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-gray-600 text-sm mb-1">Drop XYZ file or click to browse</p>
                        <input type="file" id="fileInput" class="hidden" accept=".xyz" />
                    </div>
                    <div id="fileInfo" class="mt-3 hidden">
                        <p class="text-sm text-gray-600">File: <span id="fileName" class="font-medium"></span></p>
                        <button id="clearFile" class="mt-1 text-xs text-red-600 hover:text-red-700">Clear</button>
                    </div>
                    
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Or paste XYZ coordinates:</label>
                        <textarea id="xyzInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" rows="6" placeholder="3&#10;Water molecule&#10;O  0.000000  0.000000  0.000000&#10;H  0.757000  0.586000  0.000000&#10;H -0.757000  0.586000  0.000000"></textarea>
                    </div>
                </div>

                <!-- Method Settings -->
                <div id="methodPanel" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Calculation Method</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Theory Level</label>
                            <select id="method" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="hf">Hartree-Fock (HF)</option>
                                <option value="dft-b3lyp">DFT (B3LYP)</option>
                                <option value="dft-pbe">DFT (PBE)</option>
                                <option value="dft-blyp">DFT (BLYP)</option>
                                <option value="dft-wb97x">DFT (ωB97X)</option>
                                <option value="dft-wb97m">DFT (ωB97M-V)</option>
                                <option value="dft-m06-2x">DFT (M06-2X)</option>
                                <option value="dft-pbe0">DFT (PBE0)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Basis Set</label>
                            <select id="basisSet" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="sto-3g">STO-3G</option>
                                <option value="3-21g">3-21G</option>
                                <option value="6-31g">6-31G</option>
                                <option value="6-31g(d)">6-31G(d)</option>
                                <option value="6-31g(d,p)" selected>6-31G(d,p)</option>
                                <option value="def2-svp">def2-SVP</option>
                                <option value="def2-tzvp">def2-TZVP</option>
                                <option value="cc-pvdz">cc-pVDZ</option>
                                <option value="cc-pvtz">cc-pVTZ</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- SCF Settings -->
                <div id="scfPanel" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">SCF Settings</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Max Iterations</label>
                            <input type="number" id="maxIterations" min="10" max="500" value="100" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Energy Tolerance</label>
                            <select id="energyTolerance" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1e-6">1e-6</option>
                                <option value="1e-7">1e-7</option>
                                <option value="1e-8" selected>1e-8</option>
                                <option value="1e-9">1e-9</option>
                                <option value="1e-10">1e-10</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Log Level</label>
                            <select id="logLevel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="0">Trace</option>
                                <option value="1">Debug</option>
                                <option value="2" selected>Info</option>
                                <option value="3">Warning</option>
                                <option value="4">Error</option>
                                <option value="5">Critical</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Run Button -->
                <div id="runPanel" class="hidden">
                    <button id="calculateBtn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">
                        Run Calculation
                    </button>
                    <div id="statusContent" class="mt-3 text-sm text-gray-600">
                        Upload a molecule to begin.
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="flex-1 bg-gray-50 overflow-hidden">
                <!-- Tab Navigation -->
                <div id="tabNavigation" class="bg-white border-b border-gray-200 px-6 py-3 hidden">
                    <nav class="flex space-x-6">
                        <button id="outputTab" class="py-2 px-1 border-b-2 border-blue-500 text-blue-600 text-sm font-medium">
                            Output
                        </button>
                        <button id="resultsTab" class="py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm font-medium">
                            Results
                        </button>
                        <button id="propertiesTab" class="py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm font-medium">
                            Properties
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="h-full p-6">
                    <!-- Output Tab -->
                    <div id="outputTabContent" class="h-full">
                        <div class="bg-white rounded-lg shadow h-full flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-900">Calculation Output</h3>
                                <div class="flex space-x-2">
                                    <button id="clearLogBtn" class="text-sm bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">Clear</button>
                                    <button id="scrollLogBtn" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Auto-scroll</button>
                                </div>
                            </div>
                            <div id="logOutput" class="log-output flex-1 m-4"></div>
                        </div>
                    </div>

                    <!-- Results Tab -->
                    <div id="resultsTabContent" class="h-full hidden">
                        <div class="bg-white rounded-lg shadow h-full p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Calculation Results</h3>
                            
                            <!-- Energy Results -->
                            <div id="energyResults" class="mb-6 p-4 bg-green-50 rounded-lg hidden">
                                <h4 class="text-md font-medium text-green-900 mb-2">Energies</h4>
                                <div id="energyDetails" class="text-sm text-green-800 space-y-1"></div>
                            </div>
                            
                            <!-- Timing Info -->
                            <div id="timingInfo" class="mb-4 text-sm text-gray-600"></div>
                            
                            <!-- Wavefunction Export -->
                            <div id="wavefunctionExport" class="mb-6 p-4 bg-gray-50 rounded-lg hidden">
                                <h4 class="text-md font-medium text-gray-900 mb-3">Export Wavefunction</h4>
                                <div class="flex space-x-3 mb-3">
                                    <select id="exportFormat" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="fchk">Formatted Checkpoint (.fchk)</option>
                                        <option value="json">JSON Format (.json)</option>
                                    </select>
                                    <button id="downloadWavefunction" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors font-medium">
                                        Download Wavefunction
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600">Export the calculated wavefunction for use in other quantum chemistry programs or analysis tools.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Properties Tab -->
                    <div id="propertiesTabContent" class="h-full hidden">
                        <div class="bg-white rounded-lg shadow h-full p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Molecular Properties</h3>
                            
                            <!-- Matrix Properties -->
                            <div id="matrixSection" class="mb-6 hidden">
                                <h4 class="text-md font-medium text-gray-900 mb-3">Matrix Properties</h4>
                                <div class="mb-3">
                                    <select id="matrixSelect" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="overlap">Overlap Matrix (S)</option>
                                        <option value="kinetic">Kinetic Energy Matrix (T)</option>
                                        <option value="nuclear">Nuclear Attraction Matrix (V)</option>
                                        <option value="fock">Fock Matrix (F)</option>
                                        <option value="density">Density Matrix (P)</option>
                                        <option value="coefficients">MO Coefficients (C)</option>
                                    </select>
                                </div>
                                <div id="matrixInfo" class="mb-3 p-3 bg-gray-50 rounded">
                                    <div id="matrixStats" class="text-sm text-gray-700"></div>
                                </div>
                                <div id="matrixDisplay" class="matrix-display mb-3">
                                    Select a matrix to display its values.
                                </div>
                                <button id="exportMatrixBtn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors text-sm hidden">
                                    Export Matrix as CSV
                                </button>
                            </div>

                            <!-- Orbital Properties -->
                            <div id="orbitalSection" class="hidden">
                                <h4 class="text-md font-medium text-gray-900 mb-3">Orbital Properties</h4>
                                <div id="energyList" class="text-sm space-y-1 max-h-60 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-md">
            <h3 class="text-lg font-semibold text-red-600 mb-2">Error</h3>
            <p id="errorMessage" class="text-gray-700 mb-4"></p>
            <button id="closeError" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Close</button>
        </div>
    </div>

    <script type="module">
        // Try to load from npm package first, fallback to local build
        let OCC = null;
        
        async function loadOCCModule() {
            try {
                const module = await import('@peterspackman/occjs');
                console.log('Loaded OCC from npm package');
                return module;
            } catch (e) {
                console.log('Failed to load from npm, trying local build...');
                try {
                    const module = await import('../dist/index.browser.js');
                    console.log('Loaded OCC from local build');
                    return module;
                } catch (e2) {
                    console.error('Failed to load OCC module from both npm and local build');
                    throw new Error('Could not load OCC module. Please ensure either the npm package is installed or you are running from the OCC repository.');
                }
            }
        }
        
        let currentMolecule = null;
        let currentCalculation = null;
        let autoScroll = true;

        // Initialize OCC module
        async function init() {
            console.log('Initializing OCC...');
            try {
                OCC = await loadOCCModule();
                
                const isNpmPackage = OCC.default ? true : false;
                const wasmPath = isNpmPackage ? undefined : '../dist/occjs.wasm';
                const dataPath = isNpmPackage ? undefined : '../dist/occjs.data';
                
                await OCC.loadOCC({
                    wasmPath: wasmPath,
                    dataPath: dataPath
                });
                
                console.log('OCC loaded successfully');
                updateStatus('OCC module loaded. Ready to accept molecules.');
                
                // Set up logging callback
                setupLogging();
                
            } catch (error) {
                console.error('Failed to load OCC module:', error);
                showError('Failed to load OCC module: ' + error.message);
            }
        }

        // Global log message function
        function addLogMessage(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            
            const div = document.createElement('div');
            div.className = `log-${level}`;
            div.style.marginBottom = '2px';
            div.textContent = `[${timestamp}] ${message}`;
            
            const logOutput = document.getElementById('logOutput');
            logOutput.appendChild(div);
            
            if (autoScroll) {
                logOutput.scrollTop = logOutput.scrollHeight;
            }
        }

        // Set up live logging to capture OCC WASM output
        function setupLogging() {
            
            // Register callback to capture OCC WASM logging
            const Module = OCC.getModule();
            if (Module.registerLogCallback) {
                Module.registerLogCallback((level, message) => {
                    // Map OCC log levels to our CSS classes
                    let cssLevel;
                    switch(level) {
                        case 0: // TRACE
                            cssLevel = 'debug';
                            break;
                        case 1: // DEBUG  
                            cssLevel = 'debug';
                            break;
                        case 2: // INFO
                            cssLevel = 'info';
                            break;
                        case 3: // WARN
                            cssLevel = 'warn';
                            break;
                        case 4: // ERROR
                        case 5: // CRITICAL
                            cssLevel = 'error';
                            break;
                        default:
                            cssLevel = 'info';
                    }
                    
                    // Force immediate DOM update
                    addLogMessage(message, cssLevel);
                    
                    // Force browser to repaint immediately
                    requestAnimationFrame(() => {
                        if (autoScroll) {
                            logOutput.scrollTop = logOutput.scrollHeight;
                        }
                    });
                });
                
                console.log('OCC log callback registered successfully');
            } else {
                console.warn('OCC log callback not available, falling back to console capture');
                
                // Fallback: Override console methods to capture some output
                const originalLog = console.log;
                const originalWarn = console.warn;
                const originalError = console.error;
                
                console.log = function(...args) {
                    addLogMessage(args.join(' '), 'info');
                    originalLog.apply(console, args);
                };
                
                console.warn = function(...args) {
                    addLogMessage(args.join(' '), 'warn');
                    originalWarn.apply(console, args);
                };
                
                console.error = function(...args) {
                    addLogMessage(args.join(' '), 'error');
                    originalError.apply(console, args);
                };
            }
        }

        // File handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const clearFile = document.getElementById('clearFile');
        const xyzInput = document.getElementById('xyzInput');

        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
            dropZone.classList.remove('border-gray-300');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            dropZone.classList.add('border-gray-300');
        });
        
        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            dropZone.classList.add('border-gray-300');
            
            const file = e.dataTransfer.files[0];
            if (file) await handleFile(file);
        });
        
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) await handleFile(file);
        });
        
        // Handle XYZ input changes
        xyzInput.addEventListener('input', () => {
            const xyzText = xyzInput.value.trim();
            if (xyzText) {
                loadMoleculeFromXYZ(xyzText);
            }
        });
        
        clearFile.addEventListener('click', () => {
            currentMolecule = null;
            currentCalculation = null;
            fileInput.value = '';
            xyzInput.value = '';
            fileInfo.classList.add('hidden');
            updateStatus('Upload an XYZ file or paste coordinates to begin.');
            
            // Hide all panels
            document.getElementById('methodPanel').classList.add('hidden');
            document.getElementById('scfPanel').classList.add('hidden');
            document.getElementById('runPanel').classList.add('hidden');
            document.getElementById('tabNavigation').classList.add('hidden');
            document.getElementById('moleculeHeaderInfo').classList.add('hidden');
            
            // Clear results
            document.getElementById('energyResults').classList.add('hidden');
            document.getElementById('wavefunctionExport').classList.add('hidden');
            document.getElementById('matrixSection').classList.add('hidden');
            document.getElementById('orbitalSection').classList.add('hidden');
        });

        async function handleFile(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            if (extension !== 'xyz') {
                showError('Please upload an XYZ file.');
                return;
            }
            
            fileName.textContent = file.name;
            fileInfo.classList.remove('hidden');
            updateStatus('Reading XYZ file...');
            
            try {
                const xyzContent = await file.text();
                xyzInput.value = xyzContent;
                await loadMoleculeFromXYZ(xyzContent);
            } catch (error) {
                console.error('Error loading XYZ file:', error);
                showError('Failed to load XYZ file: ' + error.message);
            }
        }

        async function loadMoleculeFromXYZ(xyzContent) {
            try {
                updateStatus('Creating molecule from XYZ...');
                currentMolecule = await OCC.moleculeFromXYZ(xyzContent);
                
                const numAtoms = currentMolecule.size();
                updateStatus(`Molecule loaded successfully. ${numAtoms} atoms.`);
                
                // Update molecule info
                updateMoleculeInfo();
                
                // Show progressive panels
                document.getElementById('methodPanel').classList.remove('hidden');
                document.getElementById('scfPanel').classList.remove('hidden');
                document.getElementById('runPanel').classList.remove('hidden');
                
                // Show tab navigation
                document.getElementById('tabNavigation').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error creating molecule:', error);
                showError('Failed to create molecule: ' + error.message);
                currentMolecule = null;
            }
        }

        function updateMoleculeInfo() {
            if (!currentMolecule) return;
            
            const numAtoms = currentMolecule.size();
            
            // Count atoms by element using atoms() method
            const elementCounts = new Map();
            const atoms = currentMolecule.atoms();
            for (let i = 0; i < numAtoms; i++) {
                const atom = atoms.get(i);
                const atomicNumber = atom.atomicNumber;
                const symbol = getElementSymbol(atomicNumber);
                elementCounts.set(symbol, (elementCounts.get(symbol) || 0) + 1);
            }
            
            // Update header info
            const moleculeName = currentMolecule.name() || 'Loaded Molecule';
            const formula = Array.from(elementCounts.entries())
                .map(([elem, count]) => count > 1 ? `${elem}${count}` : elem)
                .join('');
            
            document.getElementById('moleculeName').textContent = moleculeName;
            document.getElementById('moleculeFormula').textContent = `${formula} (${numAtoms} atoms)`;
            document.getElementById('moleculeHeaderInfo').classList.remove('hidden');
        }

        function getElementSymbol(atomicNumber) {
            const symbols = ['H', 'He', 'Li', 'Be', 'B', 'C', 'N', 'O', 'F', 'Ne',
                           'Na', 'Mg', 'Al', 'Si', 'P', 'S', 'Cl', 'Ar', 'K', 'Ca'];
            return symbols[atomicNumber - 1] || `Z${atomicNumber}`;
        }

        // Calculate button
        document.getElementById('calculateBtn').addEventListener('click', async () => {
            if (!currentMolecule) {
                showError('Please load a molecule first.');
                return;
            }
            
            // Clear previous results
            document.getElementById('energyResults').classList.add('hidden');
            document.getElementById('wavefunctionExport').classList.add('hidden');
            document.getElementById('matrixSection').classList.add('hidden');
            document.getElementById('orbitalSection').classList.add('hidden');
            
            // Clear log and switch to output tab
            document.getElementById('logOutput').innerHTML = '';
            switchTab('output');
            
            // Set log level and enable buffering for live capture
            const logLevel = parseInt(document.getElementById('logLevel').value);
            const Module = OCC.getModule();
            if (Module.setLogLevel) {
                Module.setLogLevel(logLevel);
                console.log(`Set OCC log level to ${logLevel}`);
            }
            
            // Enable log buffering if available
            if (Module.setLogBuffering) {
                Module.setLogBuffering(true);
            }
            
            // Show calculation in progress
            updateStatus('Calculation in progress... This may take a moment as WASM runs on the main thread.');
            const startTime = performance.now();
            
            try {
                const method = document.getElementById('method').value;
                const basisSet = document.getElementById('basisSet').value;
                const maxIterations = parseInt(document.getElementById('maxIterations').value);
                const energyTolerance = parseFloat(document.getElementById('energyTolerance').value);
                
                updateStatus(`Running ${method.toUpperCase()} calculation with ${basisSet} basis...`);
                console.log(`Starting ${method} calculation`);
                console.log(`Basis set: ${basisSet}`);
                console.log(`Max iterations: ${maxIterations}`);
                console.log(`Energy tolerance: ${energyTolerance}`);
                
                // Create calculation
                console.log('Creating QM calculation...');
                const calc = await OCC.createQMCalculation(currentMolecule, basisSet);
                
                // Set up SCF settings
                const settings = new OCC.SCFSettings()
                    .setMaxIterations(maxIterations)
                    .setEnergyTolerance(energyTolerance);
                
                let energy;
                if (method === 'hf') {
                    // Run HF calculation with yielding to allow UI updates
                    console.log('Running Hartree-Fock calculation...');
                    // Small delay to allow UI to update
                    await new Promise(resolve => setTimeout(resolve, 10));
                    energy = await calc.runHF(settings);
                    
                } else if (method.startsWith('dft-')) {
                    const functional = method.split('-')[1];
                    
                    // Run DFT calculation with yielding to allow UI updates
                    console.log(`Running DFT calculation with ${functional} functional...`);
                    // Small delay to allow UI to update
                    await new Promise(resolve => setTimeout(resolve, 10));
                    energy = await calc.runDFT(functional, { scfSettings: settings });
                }
                
                currentCalculation = calc;
                
                const endTime = performance.now();
                const elapsedMs = endTime - startTime;
                
                console.log('Calculation completed successfully!');
                updateStatus('Calculation completed successfully.');
                
                // Display results and switch to results tab
                displayResults(calc, elapsedMs);
                switchTab('results');
                
            } catch (error) {
                console.error('Calculation failed:', error);
                showError('Calculation failed: ' + error.message);
                updateStatus('Calculation failed.');
            }
        });

        function displayResults(calc, elapsedMs) {
            const energyDetails = document.getElementById('energyDetails');
            const timingInfo = document.getElementById('timingInfo');
            
            try {
                // Get energies
                const totalEnergy = calc.energy;
                
                let energyHTML = `<div><strong>Total Energy:</strong> ${totalEnergy.toFixed(8)} Hartree</div>`;
                energyHTML += `<div><strong>Total Energy:</strong> ${(totalEnergy * 27.2114).toFixed(6)} eV</div>`;
                
                energyDetails.innerHTML = energyHTML;
                
                // Format timing information
                const seconds = Math.floor(elapsedMs / 1000);
                const milliseconds = Math.round(elapsedMs % 1000);
                timingInfo.innerHTML = `<p>Calculation completed in ${seconds}s ${milliseconds}ms</p>`;
                
                // Show energy results
                document.getElementById('energyResults').classList.remove('hidden');
                
                // Show wavefunction export
                document.getElementById('wavefunctionExport').classList.remove('hidden');
                
                // Show property sections
                document.getElementById('matrixSection').classList.remove('hidden');
                document.getElementById('orbitalSection').classList.remove('hidden');
                
                // Update displays
                updateMatrixDisplay();
                updateOrbitalDisplay();
                
            } catch (error) {
                console.error('Error displaying results:', error);
                showError('Error displaying results: ' + error.message);
            }
        }

        function updateMatrixDisplay() {
            const matrixSelect = document.getElementById('matrixSelect');
            const currentMatrix = matrixSelect.value;
            displayMatrix(currentMatrix);
        }


        function displayMatrix(matrixType) {
            if (!currentCalculation || !currentCalculation.wavefunction) {
                document.getElementById('matrixDisplay').textContent = 'No wavefunction available. Run a calculation first.';
                return;
            }
            
            try {
                const matrixDisplay = document.getElementById('matrixDisplay');
                const matrixStats = document.getElementById('matrixStats');
                const exportBtn = document.getElementById('exportMatrixBtn');
                
                let matrix;
                let matrixName;
                const wf = currentCalculation.wavefunction;
                
                // Get matrix from wavefunction using available API
                switch(matrixType) {
                    case 'overlap':
                        matrixName = 'Overlap Matrix (S)';
                        try {
                            // Access overlap matrix through HartreeFock object
                            const Module = OCC.getModule();
                            const hf = new Module.HartreeFock(currentCalculation.basis);
                            matrix = hf.overlapMatrix();
                        } catch (e) {
                            matrixDisplay.textContent = `${matrixName}: ${e.message}`;
                            exportBtn.classList.add('hidden');
                            return;
                        }
                        break;
                    case 'kinetic':
                        matrixName = 'Kinetic Energy Matrix (T)';
                        try {
                            // Access kinetic matrix through HartreeFock object
                            const Module = OCC.getModule();
                            const hf = new Module.HartreeFock(currentCalculation.basis);
                            matrix = hf.kineticMatrix();
                        } catch (e) {
                            matrixDisplay.textContent = `${matrixName}: ${e.message}`;
                            exportBtn.classList.add('hidden');
                            return;
                        }
                        break;
                    case 'nuclear':
                        matrixName = 'Nuclear Attraction Matrix (V)';
                        try {
                            // Access nuclear attraction matrix through HartreeFock object
                            const Module = OCC.getModule();
                            const hf = new Module.HartreeFock(currentCalculation.basis);
                            matrix = hf.nuclearAttractionMatrix();
                        } catch (e) {
                            matrixDisplay.textContent = `${matrixName}: ${e.message}`;
                            exportBtn.classList.add('hidden');
                            return;
                        }
                        break;
                    case 'fock':
                        matrixName = 'Fock Matrix (F)';
                        try {
                            // Fock matrix needs to be computed through HartreeFock
                            const Module = OCC.getModule();
                            const hf = new Module.HartreeFock(currentCalculation.basis);
                            matrix = hf.fockMatrix(wf.molecularOrbitals);
                        } catch (e) {
                            matrixDisplay.textContent = `${matrixName}: ${e.message}`;
                            exportBtn.classList.add('hidden');
                            return;
                        }
                        break;
                    case 'density':
                        matrixName = 'Density Matrix (P)';
                        try {
                            // Access density matrix from molecular orbitals
                            matrix = wf.molecularOrbitals.densityMatrix;
                        } catch (e) {
                            matrixDisplay.textContent = `${matrixName}: ${e.message}`;
                            exportBtn.classList.add('hidden');
                            return;
                        }
                        break;
                    case 'coefficients':
                        matrixName = 'MO Coefficients (C)';
                        try {
                            // Access MO coefficients from wavefunction
                            matrix = wf.coefficients();
                        } catch (e) {
                            matrixDisplay.textContent = `${matrixName}: ${e.message}`;
                            exportBtn.classList.add('hidden');
                            return;
                        }
                        break;
                    default:
                        matrixDisplay.textContent = 'Unknown matrix type';
                        return;
                }
                
                if (!matrix) {
                    matrixDisplay.textContent = `${matrixName} not available`;
                    exportBtn.classList.add('hidden');
                    return;
                }
                
                const rows = matrix.rows();
                const cols = matrix.cols();
                
                // Update stats
                matrixStats.innerHTML = `<strong>${matrixName}</strong><br>Dimensions: ${rows} × ${cols}`;
                
                // Create scrollable table display for full matrix
                let matrixHTML;
                try {
                    // Show full matrix - no truncation, just make it scrollable
                    matrixHTML = `<div style="padding: 8px; font-size: 12px; color: #666; border-bottom: 1px solid #dee2e6;">Matrix size: ${rows}×${cols} (scroll to see all elements)</div>`;
                    
                    // Start building HTML table
                    matrixHTML += '<div style="padding: 8px;"><table class="matrix-table">';
                    
                    // Add column headers
                    matrixHTML += '<thead><tr><th>Row\\Col</th>';
                    for (let j = 0; j < cols; j++) {
                        matrixHTML += `<th>${j}</th>`;
                    }
                    matrixHTML += '</tr></thead><tbody>';
                    
                    // Add all data rows - no truncation
                    for (let i = 0; i < rows; i++) {
                        matrixHTML += '<tr>';
                        matrixHTML += `<th class="row-header">${i}</th>`;
                        
                        for (let j = 0; j < cols; j++) {
                            const value = matrix.get(i, j);
                            const formattedValue = Math.abs(value) < 1e-10 ? '0.000000' : value.toFixed(6);
                            matrixHTML += `<td>${formattedValue}</td>`;
                        }
                        matrixHTML += '</tr>';
                    }
                    
                    matrixHTML += '</tbody></table></div>';
                    
                } catch (e) {
                    // Fallback to text display if table creation fails
                    console.warn('Matrix table creation failed, using text fallback:', e);
                    let matrixText;
                    try {
                        if (rows > 10 || cols > 10) {
                            matrixText = `Matrix too large (${rows}×${cols}) - showing formatted text:\n\n`;
                            matrixText += matrix.toStringFormatted('{:8.4f}');
                        } else {
                            matrixText = matrix.toString();
                        }
                        matrixHTML = `<pre style="margin: 0; white-space: pre-wrap;">${matrixText}</pre>`;
                    } catch (e2) {
                        matrixHTML = `<div style="color: red;">Error displaying matrix: ${e2.message}</div>`;
                    }
                }
                
                matrixDisplay.innerHTML = matrixHTML;
                exportBtn.classList.remove('hidden');
                
                // Store matrix for export
                exportBtn.onclick = () => exportMatrix(matrix, matrixName);
                
            } catch (error) {
                console.error('Error displaying matrix:', error);
                document.getElementById('matrixDisplay').textContent = 'Error loading matrix: ' + error.message;
            }
        }


        async function updateOrbitalDisplay() {
            if (!currentCalculation || !currentCalculation.wavefunction) {
                document.getElementById('energyList').innerHTML = 'No wavefunction available. Run a calculation first.';
                return;
            }
            
            try {
                const energyList = document.getElementById('energyList');
                
                // Try to get orbital properties using the properties API from tests
                const properties = await currentCalculation.calculateProperties(['orbitals', 'homo', 'lumo', 'gap']);
                
                let energyHTML = '';
                if (properties.homo !== undefined && properties.lumo !== undefined) {
                    energyHTML += `<div class="mb-2 p-2 bg-blue-50 rounded">
                        <div class="flex justify-between">
                            <span><strong>HOMO:</strong></span>
                            <span>${properties.homo.toFixed(6)} Ha (${(properties.homo * 27.2114).toFixed(3)} eV)</span>
                        </div>
                        <div class="flex justify-between">
                            <span><strong>LUMO:</strong></span>
                            <span>${properties.lumo.toFixed(6)} Ha (${(properties.lumo * 27.2114).toFixed(3)} eV)</span>
                        </div>
                        <div class="flex justify-between">
                            <span><strong>HOMO-LUMO Gap:</strong></span>
                            <span>${properties.gap.toFixed(6)} Ha (${(properties.gap * 27.2114).toFixed(3)} eV)</span>
                        </div>
                    </div>`;
                }
                
                // Try to display orbital energies if available
                if (properties.orbitals && properties.orbitals.energies) {
                    try {
                        const energies = properties.orbitals.energies;
                        energyHTML += '<div class="mt-3"><strong>Orbital Energies:</strong></div>';
                        energyHTML += '<div class="matrix-display">';
                        // Use toString method if available
                        if (energies.toString) {
                            energyHTML += energies.toString();
                        } else {
                            energyHTML += 'Orbital energies vector toString not available';
                        }
                        energyHTML += '</div>';
                    } catch (e) {
                        energyHTML += '<div class="text-gray-600">Orbital energies display failed: ' + e.message + '</div>';
                    }
                } else {
                    energyHTML += '<div class="text-gray-600">Full orbital energies display requires API verification</div>';
                }
                
                energyList.innerHTML = energyHTML;
                
            } catch (error) {
                console.error('Error displaying orbitals:', error);
                document.getElementById('energyList').innerHTML = 'Orbital properties calculation failed: ' + error.message;
            }
        }

        function exportMatrix(matrix, name) {
            try {
                const rows = matrix.rows();
                const cols = matrix.cols();
                
                let csv = '';
                for (let i = 0; i < rows; i++) {
                    const row = [];
                    for (let j = 0; j < cols; j++) {
                        row.push(matrix.get(i, j).toString());
                    }
                    csv += row.join(',') + '\n';
                }
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${name.replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Error exporting matrix:', error);
                showError('Error exporting matrix: ' + error.message);
            }
        }

        function downloadWavefunctionFile() {
            if (!currentCalculation || !currentCalculation.wavefunction) {
                showError('No wavefunction available. Run a calculation first.');
                return;
            }
            
            try {
                const format = document.getElementById('exportFormat').value;
                const wf = currentCalculation.wavefunction;
                
                let content, filename, mimeType;
                
                switch(format) {
                    case 'fchk':
                        try {
                            // Use the properly implemented FCHK export
                            content = wf.exportToString('fchk');
                            filename = 'wavefunction.fchk';
                            mimeType = 'text/plain';
                        } catch (e) {
                            showError('FCHK export failed: ' + e.message + '. Try JSON format.');
                            return;
                        }
                        break;
                        
                    case 'json':
                        try {
                            if (wf.toJson) {
                                content = wf.toJson();
                            } else if (wf.exportToString) {
                                content = wf.exportToString('json');
                            } else {
                                throw new Error('JSON export not available');
                            }
                            filename = 'wavefunction.json';
                            mimeType = 'application/json';
                        } catch (e) {
                            showError('JSON export failed: ' + e.message);
                            return;
                        }
                        break;
                        
                    default:
                        showError('Unknown export format: ' + format);
                        return;
                }
                
                // Create and download the file
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Show success message
                addLogMessage(`Wavefunction exported as ${filename}`, 'info');
                
            } catch (error) {
                console.error('Error downloading wavefunction:', error);
                showError('Failed to download wavefunction: ' + error.message);
            }
        }

        // Setup other event listeners
        function setupOtherListeners() {
            // Matrix selection change
            const matrixSelect = document.getElementById('matrixSelect');
            if (matrixSelect) {
                matrixSelect.addEventListener('change', (e) => {
                    displayMatrix(e.target.value);
                });
            }


            // Wavefunction download
            const downloadWavefunction = document.getElementById('downloadWavefunction');
            if (downloadWavefunction) {
                downloadWavefunction.addEventListener('click', () => {
                    downloadWavefunctionFile();
                });
            }

            // Log controls
            const clearLogBtn = document.getElementById('clearLogBtn');
            const scrollLogBtn = document.getElementById('scrollLogBtn');
            
            if (clearLogBtn) {
                clearLogBtn.addEventListener('click', () => {
                    document.getElementById('logOutput').innerHTML = '';
                });
            }
            
            if (scrollLogBtn) {
                scrollLogBtn.addEventListener('click', (e) => {
                    autoScroll = !autoScroll;
                    e.target.textContent = autoScroll ? 'Auto-scroll' : 'Manual';
                    e.target.className = autoScroll ? 
                        'text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600' :
                        'text-sm bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600';
                });
            }
        }

        // Tab switching functionality
        let currentTab = 'output';
        
        function switchTab(tabName) {
            // Defensive check - make sure tabs are available
            if (!document.getElementById('outputTabContent')) {
                console.warn('Tab elements not ready yet, skipping tab switch');
                return;
            }
            
            // Hide all tab contents
            document.getElementById('outputTabContent').classList.add('hidden');
            document.getElementById('resultsTabContent').classList.add('hidden');
            document.getElementById('propertiesTabContent').classList.add('hidden');
            
            // Remove active styles from all tabs
            document.getElementById('outputTab').className = 'py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm font-medium';
            document.getElementById('resultsTab').className = 'py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm font-medium';
            document.getElementById('propertiesTab').className = 'py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm font-medium';
            
            // Show selected tab content and style
            document.getElementById(tabName + 'TabContent').classList.remove('hidden');
            document.getElementById(tabName + 'Tab').className = 'py-2 px-1 border-b-2 border-blue-500 text-blue-600 text-sm font-medium';
            
            currentTab = tabName;
        }
        
        // Tab event listeners - set up after DOM is ready
        function setupTabListeners() {
            const outputTab = document.getElementById('outputTab');
            const resultsTab = document.getElementById('resultsTab');
            const propertiesTab = document.getElementById('propertiesTab');
            
            if (outputTab && resultsTab && propertiesTab) {
                outputTab.addEventListener('click', () => switchTab('output'));
                resultsTab.addEventListener('click', () => switchTab('results'));
                propertiesTab.addEventListener('click', () => switchTab('properties'));
            }
        }

        // UI Helper functions
        function updateStatus(message) {
            document.getElementById('statusContent').innerHTML = `<p>${message}</p>`;
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
        }

        document.getElementById('closeError').addEventListener('click', () => {
            document.getElementById('errorModal').classList.add('hidden');
        });

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            setupTabListeners();
            setupOtherListeners();
        });
        
        // Initialize OCC module
        init().catch(console.error);
    </script>
</body>
</html>